#!/bin/sh

# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

NAME=apache-couchdb-2.0.0

download() {
    mkdir -p $CACHE_DIR
    cd $CACHE_DIR
    wget http://apache.mirrors.lucidnetworks.net/couchdb/source/2.0.0/$NAME.tar.gz
    tar -xvf $NAME.tar.gz
    cd -
}

install() {
    cd $CACHE_DIR/$NAME
    ./configure
    make release
    cp ./rel/couchdb $BUILD_DIR/etc/couchdb
    cd -
}

setup() {
    # create user
    adduser --system \
            --no-create-home \
            --shell /bin/bash \
            --group --gecos \
            "CouchDB Administrator" couchdb

    # user permissions
    chown -R couchdb:couchdb $BUILD_DIR/etc/couchdb/couchdb

    # set permissions
    find $BUILD_DIR/etc/couchdb/couchdb -type d -exec chmod 0770 {} \;
    chmod 0644 $BUILD_DIR/etc/couchdb/couchdb/etc/*
}

download
install
setup
